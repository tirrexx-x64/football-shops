{% extends "base.html" %}

{% block title %}Football Shop - Home{% endblock %}

{% block subtitle %}
<p class="mt-3 text-lg md:text-2xl font-extrabold animate-slideInLeft animate-delay-500 text-white">
  {{ student_name }} — {{ student_class }}
</p>

{% if user.is_authenticated %}
  <div class="mt-3 inline-block rounded-lg px-5 py-3 shadow-md animate-slideInLeft bg-gradient-to-r from-blue-100 via-indigo-100 to-purple-100">
    <p class="text-md md:text-lg font-semibold text-gray-800">
      Selamat datang, 
      <span class="text-indigo-600 font-extrabold text-lg md:text-xl tracking-wide">{{ user.username }}</span>!
    </p>
    <p class="text-sm md:text-base text-gray-600 italic mt-1">
      Last login: {{ last_login }}
    </p>
  </div>
{% endif %}
{% endblock %}

{% block content %}
<h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-6 animate-bounceIn text-center tracking-tight">
  Produk Unggulan
</h2>


<div class="mb-6 p-4 bg-yellow-50 border-2 border-yellow-400 rounded-lg max-w-4xl mx-auto">
  <p class="text-sm font-semibold text-yellow-800 mb-2">Tombol Test State</p>
  <div class="flex flex-wrap gap-2 justify-center">
    <button onclick="testLoadingState()" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
      Test Loading
    </button>
    <button onclick="testEmptyState()" class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600">
      Test Empty
    </button>
    <button onclick="testErrorState()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">
      Test Error
    </button>
    <button onclick="showToast('Product created successfully!', 'success')" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600">
      Test Toast Success
    </button>
    <button onclick="showToast('Failed to save product!', 'error')" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">
      Test Toast Error
    </button>
    <button onclick="showToast('This is an info message', 'info')" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600">
      Test Toast Info
    </button>
    <button onclick="loadFeaturedProducts()" class="px-4 py-2 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600">
      Reload Products
    </button>
  </div>
</div>

<!-- Products Container -->
<div id="featuredProductsContainer"></div>

<!-- Buttons -->
<div class="text-center mt-8 space-x-4">
  <a href="{% url 'main:product_list' %}" id="productBtn"
     class="relative inline-block bg-green-500 text-white px-8 py-4 rounded-xl font-extrabold text-lg md:text-xl shadow-lg hover:shadow-2xl hover:scale-110 transform transition-all duration-300 ease-in-out">
    Lihat Semua Produk
  </a>

  {% if user.is_authenticated %}
    <button onclick="handleLogout()" id="logoutBtn"
            class="bg-red-500 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-red-600 transition duration-300 text-base md:text-lg">
      Logout
    </button>
  {% else %}
    <a href="{% url 'main:login' %}">
      <button class="bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-600 transition duration-300 text-base md:text-lg">
        Login
      </button>
    </a>
    <a href="{% url 'main:register' %}">
      <button class="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-green-600 transition duration-300 text-base md:text-lg">
        Register
      </button>
    </a>
  {% endif %}
</div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
  // Toast notification function
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `transform transition-all duration-500 ease-in-out translate-x-0 opacity-100 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden`;
    
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
    
    toast.innerHTML = `
      <div class="p-4">
        <div class="flex items-start">
          <div class="flex-shrink-0">
            <div class="${bgColor} rounded-full p-2 text-white font-bold text-lg w-10 h-10 flex items-center justify-center">
              ${icon}
            </div>
          </div>
          <div class="ml-3 w-0 flex-1 pt-0.5">
            <p class="text-sm font-medium text-gray-900">${type === 'success' ? 'Success!' : type === 'error' ? 'Error!' : 'Info'}</p>
            <p class="mt-1 text-sm text-gray-500">${message}</p>
          </div>
          <div class="ml-4 flex-shrink-0 flex">
            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                    class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none">
              <span class="text-2xl">&times;</span>
            </button>
          </div>
        </div>
      </div>
      <div class="h-1 ${bgColor} toast-progress"></div>
    `;
    
    document.getElementById('toastContainer').appendChild(toast);
    
    setTimeout(() => {
      toast.style.transform = 'translateX(400px)';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 500);
    }, 4000);
  }


  async function loadFeaturedProducts() {
    const container = document.getElementById('featuredProductsContainer');
    
    // Show loading
    container.innerHTML = `
      <div class="flex justify-center items-center py-16">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
      </div>
    `;
    
    try {
      const response = await fetch("{% url 'main:get_products_ajax' %}");
      const data = await response.json();
      const products = data.products.filter(p => p.is_featured);
      
      if (products.length === 0) {
        container.innerHTML = `
          <p class="text-center text-gray-500 italic py-8">Tidak ada produk unggulan saat ini.</p>
        `;
        return;
      }
      
      let html = '<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">';
      
      products.forEach(product => {
        html += `
          <div class="bg-white border rounded-xl shadow-md hover:shadow-xl hover:scale-105 transform transition-all duration-300">
            <img src="${product.thumbnail || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                 alt="${product.name}" 
                 class="w-full h-44 object-cover rounded-t-xl">
            <div class="p-4">
              <h3 class="text-lg md:text-xl font-semibold text-gray-900 tracking-wide">${product.name}</h3>
              <p class="text-green-600 font-bold mt-1 text-md md:text-lg">Rp ${product.price.toLocaleString('id-ID')}</p>
              <span class="inline-block mt-2 text-sm md:text-base text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${product.category || 'Uncategorized'}</span>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
      
    } catch (error) {
      console.error('Error:', error);
      container.innerHTML = `
        <p class="text-center text-red-500 py-8">Failed to load products</p>
      `;
    }
  }

 
  async function handleLogout() {
    const btn = document.getElementById('logoutBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="animate-pulse">Logging out...</span>';
    btn.disabled = true;
    
    try {
      const response = await fetch("{% url 'main:logout_ajax' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        showToast(data.message, 'success');
        setTimeout(() => {
          window.location.href = "{% url 'main:login' %}";
        }, 1000);
      } else {
        showToast('Logout failed', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    } catch (error) {
      showToast('An error occurred', 'error');
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }


 
function testLoadingState() {
  const container = document.getElementById('featuredProductsContainer');
  container.innerHTML = `
    <div class="flex justify-center items-center py-16">
      <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
      <p class="ml-4 text-gray-600 text-lg">Loading products...</p>
    </div>
  `;
}

function testEmptyState() {
  const container = document.getElementById('featuredProductsContainer');
  container.innerHTML = `
    <div class="flex flex-col items-center justify-center py-16">
      <img src="https://cdn-icons-png.flaticon.com/512/4076/4076508.png" 
           alt="No Products" class="w-40 h-40 mb-4 opacity-70">
      <p class="text-center text-gray-500 italic py-8">Tidak ada produk unggulan saat ini.</p>
    </div>
  `;
}

function testErrorState() {
  const container = document.getElementById('featuredProductsContainer');
  container.innerHTML = `
    <div class="flex flex-col items-center justify-center py-16">
      <svg class="w-20 h-20 text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-center text-red-500 py-4 text-lg font-semibold">Failed to load products</p>
      <p class="text-center text-gray-500 text-sm mb-4">This is a test error message</p>
      <button onclick="loadFeaturedProducts()" 
              class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
        Try Again
      </button>
    </div>
  `;
}

  
  document.addEventListener('DOMContentLoaded', function() {
    loadFeaturedProducts();
  });
</script>

<style>
  @keyframes progress {
    from { width: 100%; }
    to { width: 0%; }
  }
  
  .toast-progress {
    animation: progress 4s linear;
  }
</style>

{% endblock %}